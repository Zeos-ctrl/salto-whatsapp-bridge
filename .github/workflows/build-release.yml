name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-windows-package:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install pkg globally
      run: npm install -g pkg
    
    - name: Install zip utility
      run: sudo apt-get install -y zip wget unzip
    
    - name: Download NSSM
      run: |
        echo "Downloading NSSM..."
        wget https://nssm.cc/release/nssm-2.24.zip -O nssm.zip
        unzip nssm.zip
        mkdir -p nssm-dist
        mv nssm-2.24 nssm-dist/nssm
        echo "NSSM downloaded and extracted"
    
    - name: Create missing files
      run: |
        # Create .env.example if it doesn't exist
        if [ ! -f .env.example ]; then
          cat > .env.example << 'EOF'
        PORT=3000
        WHATSAPP_TARGETS=
        EOF
        fi
        
        # Create LICENSE.txt if it doesn't exist
        if [ ! -f installer/LICENSE.txt ]; then
          cat > installer/LICENSE.txt << 'EOF'
        MIT License
        
        Copyright (c) 2024
        
        Permission is hereby granted, free of charge, to any person obtaining a copy
        of this software and associated documentation files (the "Software"), to deal
        in the Software without restriction, including without limitation the rights
        to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
        copies of the Software, and to permit persons to whom the Software is
        furnished to do so, subject to the following conditions:
        
        The above copyright notice and this permission notice shall be included in all
        copies or substantial portions of the Software.
        
        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
        IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
        AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
        LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
        OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
        SOFTWARE.
        EOF
        fi
        
        # Create README.md if it doesn't exist
        if [ ! -f installer/README.md ]; then
          cat > installer/README.md << 'EOF'
        # Salto-WhatsApp Bridge
        
        See INSTALL.txt for installation instructions.
        Requires NSSM - see INSTALL_REQUIREMENTS.txt
        EOF
        fi
        
        # Create INSTALL_REQUIREMENTS.txt
        cat > installer/INSTALL_REQUIREMENTS.txt << 'EOF'
        NSSM INSTALLATION GUIDE
        =======================
        
        NSSM is included in this package at: nssm\win64\nssm.exe
        
        The installer will use NSSM automatically from this location.
        
        If you prefer to install NSSM globally:
        1. Copy the 'nssm' folder to C:\nssm
        2. The installer will work from either location
        
        Manual Installation:
        If the installer fails, you can install the service manually:
        
        1. Open Command Prompt as Administrator
        2. Run:
           nssm\win64\nssm.exe install "Salto WhatsApp Bridge" "C:\Program Files\nodejs\node.exe" "src\server.js"
           nssm\win64\nssm.exe set "Salto WhatsApp Bridge" AppDirectory "%CD%"
           nssm\win64\nssm.exe start "Salto WhatsApp Bridge"
        
        For more information: https://nssm.cc/
        EOF
    
    - name: Make build script executable
      run: chmod +x installer/build-linux.sh
    
    - name: Update build script to include NSSM
      run: |
        # Update the build script to copy NSSM
        sed -i '/# Copy service installation scripts/a \
        \
        # Copy NSSM\
        echo "  - Copying NSSM..."\
        cp -r nssm-dist/nssm "$PACKAGE_DIR/"' installer/build-linux.sh
    
    - name: Build Windows package
      run: ./installer/build-linux.sh
    
    - name: Verify NSSM is in package
      run: |
        cd dist/package/salto-whatsapp-bridge
        if [ -f "nssm/win64/nssm.exe" ]; then
          echo "✓ NSSM included in package"
          ls -lh nssm/win64/nssm.exe
        else
          echo "✗ NSSM not found in package!"
          exit 1
        fi
    
    - name: Get version
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "version=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: salto-whatsapp-bridge-${{ steps.version.outputs.version }}
        path: dist/salto-whatsapp-bridge-v1.0.0-win64.zip
        retention-days: 30
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/salto-whatsapp-bridge-v1.0.0-win64.zip
        body: |
          ## Salto-WhatsApp Bridge ${{ steps.version.outputs.version }}
          
          ### Installation
          1. Download the ZIP file below
          2. Extract to a permanent location on Windows Server
          3. **NSSM is included** - no separate download needed!
          4. Run `install-service.bat` as Administrator
          5. Open http://localhost:3000 to configure

          ### What's Included
          - WhatsApp Web integration
          - Web-based dark mode configuration interface
          - **NSSM service manager** (bundled)
          - Windows Service installer
          - Multi-target support (groups and individuals)
          - Automatic service restart on failure
          - Log rotation
          
          ### Requirements
          - Windows Server 2016 or later
          - Node.js v18 or higher (download from nodejs.org)
          
          ### Quick Start

          # Extract ZIP, then:
          1. Right-click install-service.bat → Run as Administrator
          2. Open http://localhost:3000
          3. Scan QR code with WhatsApp
          4. Add your groups/contacts
          See README.md in the package for full documentation.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
